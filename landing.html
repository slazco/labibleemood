<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program Rasio Keuangan by Leemood</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <style>
        /* Custom CSS for finer control and animations */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2f7, #c1e7f0); /* Soft blue gradient */
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto; /* Allow scrolling if content overflows */
        }
        .container {
            background-color: #ffffff;
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            padding: 3rem; /* More padding */
            width: 100%;
            max-width: 960px; /* Slightly wider */
            display: flex;
            flex-direction: column;
            gap: 2rem; /* More space between sections */
            animation: fadeInScale 0.6s ease-out;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        h1 {
            font-size: 3rem; /* Larger title */
            font-weight: 700;
            color: #2c3e50; /* Darker blue-grey */
            text-align: center;
            margin-bottom: 2rem;
            letter-spacing: -0.05em; /* Tighter letter spacing */
        }
        h2 {
            font-size: 2rem; /* Larger section titles */
            font-weight: 600;
            color: #34495e;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid #e0e0e0; /* Thicker border */
            padding-bottom: 0.75rem;
            position: relative;
        }
        h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -3px;
            width: 80px; /* Accent underline */
            height: 3px;
            background-color: #3498db; /* Primary color accent */
        }
        .input-section, .analysis-section {
            background-color: #fcfcfc;
            border: 1px solid #e0e0e0;
            border-radius: 15px; /* More rounded */
            padding: 2rem; /* More padding */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }
        .form-group {
            margin-bottom: 1.25rem; /* More spacing */
        }
        label {
            display: block;
            margin-bottom: 0.6rem; /* More spacing */
            font-weight: 600; /* Bolder labels */
            color: #444;
            font-size: 0.95rem;
        }
        input[type="file"], input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 0.9rem; /* More padding */
            border: 1px solid #d1d5db; /* Lighter border */
            border-radius: 10px; /* Rounded inputs */
            font-size: 1rem;
            color: #333;
            transition: all 0.3s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        input[type="file"]:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.3); /* Stronger focus ring */
            outline: none;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 1rem 2rem; /* More padding */
            border: none;
            border-radius: 10px; /* Rounded buttons */
            font-size: 1.05rem; /* Slightly larger font */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother transition */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: inline-flex; /* For icon alignment */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space for icon */
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-3px); /* Lift effect */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        .message {
            margin-top: 1.25rem; /* More spacing */
            padding: 1rem; /* More padding */
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .message.success {
            background-color: #e6ffe6;
            color: #27ae60;
            border: 1px solid #c6f6d5;
        }
        .message.error {
            background-color: #ffe6e6;
            color: #e74c3c;
            border: 1px solid #f6c6c6;
        }
        .message.info {
            background-color: #e0f2f7;
            color: #3498db;
            border: 1px solid #b3e0f2;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 2rem; /* More spacing */
            border-radius: 12px; /* Rounded table container */
            border: 1px solid #e0e0e0;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        }
        table {
            width: 100%;
            border-collapse: separate; /* For rounded corners */
            border-spacing: 0;
            min-width: 700px; /* Ensure table is wide enough */
        }
        th, td {
            padding: 1rem 1.2rem; /* More padding */
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        th:first-child { border-top-left-radius: 12px; }
        th:last-child { border-top-right-radius: 12px; }
        tbody tr:last-child td { border-bottom: none; } /* Remove bottom border for last row */
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #eef7ff;
            transition: background-color 0.2s ease;
        }
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        .login-box {
            background-color: white;
            padding: 3rem; /* More padding */
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            text-align: center;
            width: 90%;
            max-width: 450px; /* Slightly wider */
            animation: slideIn 0.4s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .login-box h2 {
            font-size: 2.2rem; /* Larger title */
            margin-bottom: 2rem;
            color: #2c3e50;
            border-bottom: none; /* Remove border for login box title */
            padding-bottom: 0;
        }
        .login-box label {
            text-align: left;
            width: 100%;
            font-size: 1rem;
        }
        .login-box input {
            margin-bottom: 1.5rem; /* More spacing */
        }
        .login-box button {
            width: 100%;
            padding: 1rem; /* Consistent button padding */
            font-size: 1.1rem;
        }
        .hidden {
            display: none !important;
        }
        .flex-col-gap {
            display: flex;
            flex-direction: column;
            gap: 1.25rem; /* Consistent gap for form groups */
        }
        .file-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .file-input-group input[type="file"] {
            padding: 0.75rem; /* Adjust padding for file input */
        }
        .processing-indicator {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9em;
            color: #555;
        }
        /* Icons for messages */
        .message .icon {
            font-size: 1.2em;
            line-height: 1;
        }
        .message.success .icon { color: #27ae60; }
        .message.error .icon { color: #e74c3c; }
        .message.info .icon { color: #3498db; }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 1.5rem;
                border-radius: 15px;
                gap: 1.5rem;
            }
            h1 {
                font-size: 2.2rem;
                margin-bottom: 1.5rem;
            }
            h2 {
                font-size: 1.6rem;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
            }
            .input-section, .analysis-section {
                padding: 1.2rem;
                border-radius: 12px;
            }
            label {
                font-size: 0.9rem;
                margin-bottom: 0.4rem;
            }
            input[type="file"], input[type="text"], input[type="number"], select {
                padding: 0.7rem;
                font-size: 0.95rem;
                border-radius: 8px;
            }
            button {
                padding: 0.8rem 1.2rem;
                font-size: 0.95rem;
                border-radius: 8px;
            }
            .message {
                padding: 0.8rem;
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.7rem 0.9rem;
                font-size: 0.85rem;
            }
            .login-box {
                padding: 2rem;
                border-radius: 10px;
            }
            .login-box h2 {
                font-size: 1.8rem;
                margin-bottom: 1.5rem;
            }
            .login-box input {
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
                gap: 1rem;
            }
            h1 {
                font-size: 1.8rem;
                margin-bottom: 1rem;
            }
            h2 {
                font-size: 1.3rem;
                margin-bottom: 0.8rem;
                padding-bottom: 0.4rem;
            }
            h2::after {
                width: 60px;
            }
            .input-section, .analysis-section {
                padding: 1rem;
            }
            label {
                font-size: 0.85rem;
            }
            input[type="file"], input[type="text"], input[type="number"], select {
                padding: 0.6rem;
                font-size: 0.9rem;
                border-radius: 6px;
            }
            button {
                padding: 0.7rem 1rem;
                font-size: 0.9rem;
                border-radius: 6px;
                gap: 5px;
            }
            .message {
                padding: 0.6rem;
                font-size: 0.85rem;
                gap: 8px;
            }
            th, td {
                padding: 0.5rem 0.7rem;
                font-size: 0.8rem;
            }
            .login-box {
                padding: 1.5rem;
            }
            .login-box h2 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="appContainer" class="container hidden">
        <h1>Program Rasio Keuangan</h1>

        <div class="input-section">
            <h2>Input Data</h2>
            <div class="flex-col-gap">
                <div class="form-group file-input-group">
                    <label for="penghasilanFileInput">Dokumen Penghasilan (Excel):</label>
                    <input type="file" id="penghasilanFileInput" accept=".xlsx" multiple onchange="handleFileInput('penghasilan')">
                    <div id="penghasilanStatus" class="message info hidden"></div>
                </div>

                <div class="form-group file-input-group">
                    <label for="orderFileInput">Dokumen Order (Excel):</label>
                    <input type="file" id="orderFileInput" accept=".xlsx" multiple onchange="handleFileInput('order')">
                    <div id="orderStatus" class="message info hidden"></div>
                </div>

                <div class="form-group">
                    <label for="iklanInputMonth">Biaya Iklan (Bulan):</label>
                    <select id="iklanInputMonth" class="mb-2">
                        <option value="">Pilih Bulan</option>
                    </select>
                    <label for="iklanInputAmount">Nominal Biaya Iklan (Rp):</label>
                    <input type="number" id="iklanInputAmount" placeholder="Contoh: 1500000" class="mb-2">
                    <button onclick="inputBiaya('iklan')">
                        <span class="text-lg">üí∏</span> Simpan Biaya Iklan
                    </button>
                    <div id="iklanStatus" class="message info hidden"></div>
                </div>

                <div class="form-group">
                    <label for="operasionalInputMonth">Biaya Operasional (Bulan):</label>
                    <select id="operasionalInputMonth" class="mb-2">
                        <option value="">Pilih Bulan</option>
                    </select>
                    <label for="operasionalInputAmount">Nominal Biaya Operasional (Rp):</label>
                    <input type="number" id="operasionalInputAmount" placeholder="Contoh: 500000" class="mb-2">
                    <button onclick="inputBiaya('operasional')">
                        <span class="text-lg">üè¢</span> Simpan Biaya Operasional
                    </button>
                    <div id="operasionalStatus" class="message info hidden"></div>
                </div>

                <div class="form-group">
                    <button onclick="inputHPPProduk()" id="hppButton">
                        <span class="text-lg">üè∑Ô∏è</span> Input HPP Produk (Stok Barang)
                    </button>
                    <div id="hppStatus" class="message info hidden"></div>
                </div>
            </div>
            <div class="form-group mt-8">
                <button onclick="resetAllData()" class="bg-red-500 hover:bg-red-600">
                    <span class="text-lg">üóëÔ∏è</span> Reset Semua Data
                </button>
            </div>
        </div>

        <div class="analysis-section">
            <h2>Analisis Keuangan</h2>
            <div class="flex-col-gap">
                <div class="form-group">
                    <label for="analysisMonthSelect">Pilih Bulan untuk Analisis Detail:</label>
                    <select id="analysisMonthSelect">
                        <option value="">Pilih Bulan</option>
                    </select>
                    <button onclick="displaySingleMonthAnalysis()" id="analyzeButton" disabled>
                        <span class="text-lg">üîç</span> Tampilkan Analisis Detail
                    </button>
                </div>
                <div class="form-group">
                    <button onclick="displayAllMonthsSummary()" id="summaryButton" disabled>
                        <span class="text-lg">üìà</span> Tampilkan Ringkasan Semua Bulan
                    </button>
                </div>
                <div class="form-group">
                    <button onclick="exportReports()" id="exportButton" disabled>
                        <span class="text-lg">üíæ</span> Ekspor Laporan ke Excel
                    </button>
                </div>
            </div>
            <div id="analysisOutput" class="table-container hidden"></div>
        </div>
    </div>

    <!-- License/Login Overlay -->
    <div id="licenseOverlay" class="login-overlay">
        <div class="login-box">
            <h2>Verifikasi Lisensi</h2>
            <div class="form-group">
                <label for="licenseInput">Kode Lisensi:</label>
                <input type="text" id="licenseInput" placeholder="Masukkan Kode Lisensi Anda">
            </div>
            <button onclick="verifyLicense()">Verifikasi</button>
            <div id="licenseMessage" class="message hidden"></div>
            <p class="text-gray-500 text-sm mt-4">Percobaan sisa: <span id="attemptsLeft">3</span></p>
        </div>
    </div>

    <script>
(function() {
    // Firebase Configuration and Secret Key (Base64 encoded)
    const _fb_s_b64 = "RkF5UWx6ZzVYMDFUc2NTVTY2U0oyVmFTYkI4aTk2ZVZLOHF0T0VXdg=="; // Your Firebase Secret Key
    const _fb_b_b64 = "aHR0cHM6Ly9yYXNpb2tldWFuZ2FuLWI0Yzg4LWRlZmF1bHQtcnRkYi5hc2lhLXNvdXRoZWFzdDEuZmlyZWJhc2VkYXRhYmFzZS5hcHA="; // Your Firebase Base URL

    // Decode Base64 strings
    const _atob = (str) => {
        try { return atob(str); } catch (e) { console.error("Base64 decoding error:", e); return ""; }
    };
    const _fb_s = _atob(_fb_s_b64);
    const _fb_b = _atob(_fb_b_b64);
    const _fb_licenses_url_base = `${_fb_b}/licenses.json?auth=${_fb_s}`;

    // Global Data Storage
    let _data_penghasilan = {}; // Key: Month (e.g., 'Jan'), Value: { Summary: DataFrame, Income: DataFrame, income_col_name: string }
    let _data_order = {};       // Key: Month (e.g., 'Jan'), Value: DataFrame
    let _data_iklan = {};       // Key: Month (e.g., 'Jan'), Value: number
    let _data_operasional = {}; // Key: Month (e.g., 'Jan'), Value: number
    let _data_hpp = {};         // Key: ProductKey, Value: number

    // Track months with data
    let _bulan_penghasilan = [];
    let _bulan_order = [];
    let _bulan_iklan = [];
    let _bulan_operasional = [];

    // Obfuscated month mappings
    const _mo = {
        'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'Mei': 5, 'Jun': 6,
        'Jul': 7, 'Agu': 8, 'Sep': 9, 'Okt': 10, 'Nov': 11, 'Des': 12
    };
    const _rmo = Object.fromEntries(Object.entries(_mo).map(([k, v]) => [v, k]));
    const _min = {
        'jan': 'Jan', 'januari': 'Jan', 'feb': 'Feb', 'februari': 'Feb',
        'mar': 'Mar', 'maret': 'Mar', 'apr': 'Apr', 'april': 'Apr',
        'mei': 'Mei', 'jun': 'Jun', 'juni': 'Jun', 'jul': 'Jul', 'juli': 'Jul',
        'agu': 'Agu', 'agustus': 'Agu', 'sep': 'Sep', 'september': 'Sep',
        'okt': 'Okt', 'oktober': 'Okt', 'nov': 'Nov', 'november': 'Nov',
        'des': 'Des', 'desember': 'Des'
    };
    const _fmn = {
        'Jan': 'JANUARI', 'Feb': 'FEBRUARI', 'Mar': 'MARET', 'Apr': 'APRIL', 'Mei': 'MEI', 'Jun': 'JUNI',
        'Jul': 'JULI', 'Agu': 'AGUSTUS', 'Sep': 'SEPTEMBER', 'Okt': 'OKTOBER', 'Nov': 'NOVEMBER', 'Des': 'DESEMBER'
    };

    const _scm = {
        "TOTAL PENDAPATAN (SUMMARY)": "PENDAPATAN", "TOTAL PENGHASILAN (INCOME)": "PENGHASILAN",
        "HPP": "HPP", "BIAYA OPERASIONAL": "OPERASIONAL", "BIAYA IKLAN": "IKLAN",
        "LABA KOTOR": "LABA KOTOR", "LABA BERSIH": "LABA BERSIH",
        "RASIO ADMIN & LAYANAN": "ADM & LYN %", "RASIO OPERASIONAL": "OPS %",
        "AOV AKTUAL": "AOV", "BASKET SIZE AKTUAL": "BASKET SIZE",
        "ROAS AKTUAL": "ROAS", "ACOS AKTUAL": "ACOS", "RASIO MARGIN": "MARGIN %",
        "RASIO LABA": "LABA %", "STATUS LABA": "STATUS"
    };

    const ORDER_ID_COL = "No. Pesanan";
    const QUANTITY_COL = "Jumlah";
    const PRODUCT_IDENTIFIER_COLS = ["SKU Induk", "Nama Produk", "Nomor Referensi SKU", "Nama Variasi"];

    // --- License Verification Logic ---
    let _attempts_left = 3;
    const _license_cache_key = "rk_license_code";
    const _device_id_key = "rk_device_id";

    function _get_device_id() {
        let deviceId = localStorage.getItem(_device_id_key);
        if (!deviceId) {
            deviceId = uuid.v4(); // Generate a unique ID
            localStorage.setItem(_device_id_key, deviceId);
            console.log("[DEBUG] Generated new device ID:", deviceId);
        } else {
            console.log("[DEBUG] Reusing existing device ID:", deviceId);
        }
        return deviceId;
    }

    async function _check_license_validity(licenseCode, currentDeviceId) {
        if (!licenseCode) { return { isValid: false, message: "Kode lisensi tidak boleh kosong." }; }

        try {
            const res = await fetch(`${_fb_b}/licenses/${licenseCode}.json?auth=${_fb_s}`);
            if (!res.ok) {
                if (res.status === 401) {
                    return { isValid: false, message: "Secret Key Firebase tidak valid atau kadaluarsa." };
                }
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const licenseInfo = await res.json();
            console.log("[DEBUG] License info from Firebase before linking:", licenseInfo);


            if (!licenseInfo) { return { isValid: false, message: `Lisensi '${licenseCode}' tidak ditemukan.` }; }
            if (!licenseInfo.active) { return { isValid: false, message: `Lisensi '${licenseCode}' tidak aktif. Hubungi administrator.` }; }

            const expireDateStr = licenseInfo.expire;
            if (!expireDateStr) { return { isValid: false, message: `Tanggal kadaluarsa lisensi '${licenseCode}' tidak ditemukan. Hubungi administrator.` }; }

            const expireDate = new Date(expireDateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date

            if (expireDate < today) { return { isValid: false, message: `Lisensi '${licenseCode}' telah kadaluarsa pada ${expireDateStr}. Hubungi administrator.` }; }

            const linkedDeviceId = licenseInfo.device_id;
            if (linkedDeviceId && linkedDeviceId !== currentDeviceId) {
                return { isValid: false, message: `Lisensi '${licenseCode}' sudah digunakan di perangkat lain.` };
            }

            return { isValid: true, message: `Lisensi '${licenseCode}' valid.`, licenseInfo: licenseInfo };

        } catch (e) {
            return { isValid: false, message: `Terjadi error saat memverifikasi lisensi: ${e.message}` };
        }
    }

    async function _is_device_id_linked_to_other_active_license(currentDeviceId, excludingLicenseCode = null) {
        try {
            const res = await fetch(_fb_licenses_url_base);
            if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
            const allLicensesData = await res.json();

            if (!allLicensesData) { return false; }

            for (const licenseCode in allLicensesData) {
                if (licenseCode === excludingLicenseCode) { continue; }
                const info = allLicensesData[licenseCode];
                if (info && info.active && info.device_id === currentDeviceId) {
                    return true;
                }
            }
            return false;
        } catch (e) {
            console.error("Error checking other licenses:", e);
            return true; // Assume linked for safety if error occurs
        }
    }

    async function _link_license_to_device(licenseCode, deviceId) {
        console.log(`[DEBUG] Attempting to link license '${licenseCode}' to device '${deviceId}'`);
        try {
            const updateUrl = `${_fb_b}/licenses/${licenseCode}.json?auth=${_fb_s}`;
            const payload = { device_id: deviceId };
            const res = await fetch(updateUrl, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const errorResponse = await res.text(); // Get raw text for more info
                console.error(`[ERROR] Failed to link license '${licenseCode}' to device '${deviceId}'. HTTP Status: ${res.status}. Response:`, errorResponse);
                throw new Error(`HTTP error! Status: ${res.status}. Firebase response: ${errorResponse}`);
            }
            console.log(`[DEBUG] Successfully linked license '${licenseCode}' to device '${deviceId}'`);
            return true;
        } catch (e) {
            console.error(`[ERROR] Exception when linking license '${licenseCode}' to device:`, e);
            return false;
        }
    }

    async function verifyLicense() {
        const licenseInput = document.getElementById("licenseInput");
        const licenseMessage = document.getElementById("licenseMessage");
        const attemptsLeftSpan = document.getElementById("attemptsLeft");
        const appContainer = document.getElementById("appContainer");
        const licenseOverlay = document.getElementById("licenseOverlay");

        const licenseCode = licenseInput.value.trim();
        const currentDeviceId = _get_device_id(); // Get or generate device ID

        licenseMessage.classList.add("hidden"); // Hide previous message

        if (!licenseCode) {
            _display_message("licenseMessage", "Kode lisensi tidak boleh kosong.", "error", '<span class="icon">‚ö†Ô∏è</span>');
            return;
        }

        const { isValid, message, licenseInfo } = await _check_license_validity(licenseCode, currentDeviceId);

        if (isValid) {
            const isLinkedToOther = await _is_device_id_linked_to_other_active_license(currentDeviceId, licenseCode);
            if (isLinkedToOther) {
                _display_message("licenseMessage", 'Perangkat ini sudah terhubung dengan lisensi aktif lainnya. Hanya satu lisensi yang diizinkan per perangkat.', "error", '<span class="icon">‚ùå</span>');
                _attempts_left--;
                attemptsLeftSpan.textContent = _attempts_left;
            } else {
                // This is the crucial part: if device_id is null or empty, link it.
                if (licenseInfo.device_id === null || licenseInfo.device_id === "") {
                    const linked = await _link_license_to_device(licenseCode, currentDeviceId);
                    if (linked) {
                        localStorage.setItem(_license_cache_key, licenseCode);
                        _display_message("licenseMessage", `Lisensi valid! Selamat datang (ID Lisensi: ${licenseCode}).`, "success", '<span class="icon">‚úÖ</span>');
                        setTimeout(() => {
                            licenseOverlay.classList.add("hidden");
                            appContainer.classList.remove("hidden");
                            _init_app(); // Initialize main app
                        }, 1000);
                    } else {
                        _display_message("licenseMessage", 'Gagal menghubungkan lisensi ke perangkat. Coba lagi.', "error", '<span class="icon">‚ùå</span>');
                        _attempts_left--;
                        attemptsLeftSpan.textContent = _attempts_left;
                    }
                } else {
                    // If device_id already exists and matches currentDeviceId, proceed
                    localStorage.setItem(_license_cache_key, licenseCode);
                    _display_message("licenseMessage", `Lisensi valid dan sudah terhubung ke perangkat ini. Selamat datang (ID Lisensi: ${licenseCode}).`, "success", '<span class="icon">‚úÖ</span>');
                    setTimeout(() => {
                        licenseOverlay.classList.add("hidden");
                        appContainer.classList.remove("hidden");
                        _init_app(); // Initialize main app
                    }, 1000);
                }
            }
        } else {
            _display_message("licenseMessage", message, "error", '<span class="icon">‚ùå</span>');
            _attempts_left--;
            attemptsLeftSpan.textContent = _attempts_left;
        }

        if (_attempts_left <= 0) {
            licenseInput.disabled = true;
            document.querySelector("#licenseOverlay button").disabled = true;
            _display_message("licenseMessage", 'Anda telah mencapai batas percobaan. Program tidak dapat digunakan.', "error", '<span class="icon">‚õî</span>');
        }
    }

    async function _init_license_check() {
        const cachedLicenseCode = localStorage.getItem(_license_cache_key);
        const currentDeviceId = _get_device_id(); // Get or generate device ID
        const licenseMessage = document.getElementById("licenseMessage");
        const appContainer = document.getElementById("appContainer");
        const licenseOverlay = document.getElementById("licenseOverlay");

        // Ensure license overlay is visible by default
        licenseOverlay.classList.remove("hidden"); // THIS LINE IS CRUCIAL FOR INITIAL DISPLAY

        if (cachedLicenseCode) {
            _display_message("licenseMessage", 'Mencoba memverifikasi lisensi dari cache...', "info", '<span class="icon">‚ÑπÔ∏è</span>');

            const { isValid, message, licenseInfo } = await _check_license_validity(cachedLicenseCode, currentDeviceId);

            if (isValid) {
                const isLinkedToOther = await _is_device_id_linked_to_other_active_license(currentDeviceId, cachedLicenseCode);
                if (isLinkedToOther) {
                    _display_message("licenseMessage", 'Perangkat ini sudah terhubung dengan lisensi aktif lainnya. Hanya satu lisensi yang diizinkan per perangkat.', "error", '<span class="icon">‚ùå</span>');
                    localStorage.removeItem(_license_cache_key); // Clear cache if invalid due to other license
                    document.getElementById("attemptsLeft").textContent = _attempts_left; // Reset attempts for manual input
                } else {
                    _display_message("licenseMessage", `Lisensi perangkat valid! Selamat datang kembali (ID Lisensi: ${cachedLicenseCode}).`, "success", '<span class="icon">‚úÖ</span>');
                    setTimeout(() => {
                        licenseOverlay.classList.add("hidden");
                        appContainer.classList.remove("hidden");
                        _init_app();
                    }, 1000);
                    return; // Exit if valid
                }
            } else {
                    _display_message("licenseMessage", `Lisensi cached tidak valid: ${message}. Silakan masukkan kode lisensi secara manual.`, "error", '<span class="icon">‚ùå</span>');
                    localStorage.removeItem(_license_cache_key); // Clear cache if invalid
                    document.getElementById("attemptsLeft").textContent = _attempts_left; // Reset attempts for manual input
            }
        } else {
            _display_message("licenseMessage", 'Tidak ada lisensi di cache lokal. Silakan masukkan kode lisensi.', "info", '<span class="icon">‚ÑπÔ∏è</span>');
        }
        // If we reach here, either no cache or cached license was invalid, so show overlay
        // This is already handled by removing "hidden" at the beginning of the function.
    }

    // --- Core Application Logic ---

    function _normalize_month_input(userInputMonth) {
        return _min[userInputMonth.trim().toLowerCase()] || null;
    }

    function _extract_month_from_filename(filename) {
        const match = filename.match(/(\d{4})(\d{2})\d{2}(?:_\d{8})?/);
        if (match) {
            const monthNum = parseInt(match[2], 10);
            if (monthNum >= 1 && monthNum <= 12) {
                return _rmo[monthNum];
            }
        }
        return null;
    }

    function _display_message(elementId, msg, type, iconHtml = '') {
        const el = document.getElementById(elementId);
        if (el) {
            el.innerHTML = `${iconHtml} ${msg}`;
            el.className = `message ${type}`;
            el.classList.remove("hidden");
            // Clear message after 5 seconds unless it's a persistent error
            if (type !== "error" || !msg.includes("tidak dapat digunakan")) {
                setTimeout(() => { el.classList.add("hidden"); }, 5000);
            }
        }
    }

    async function handleFileInput(type) {
        const fileInput = document.getElementById(`${type}FileInput`);
        const statusElementId = `${type}Status`;
        const files = fileInput.files;

        if (files.length === 0) {
            _display_message(statusElementId, "Tidak ada file yang dipilih.", "error", '<span class="icon">‚ö†Ô∏è</span>');
            return;
        }

        _display_message(statusElementId, `<span class="processing-indicator">Memproses file...</span>`, "info", '<span class="icon">‚è≥</span>');
        
        let allFilesProcessed = true;
        for (const file of files) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const detectedMonth = _extract_month_from_filename(file.name);
                    let month = detectedMonth;

                    if (!month) {
                        // Using custom modal/prompt for better UX
                        const userInput = await _custom_prompt(`Bulan tidak terdeteksi otomatis dari nama file: ${file.name}.\nMasukkan bulan (misal: Jan, Februari):`);
                        month = _normalize_month_input(userInput);
                        if (!month) {
                            _display_message(statusElementId, `Bulan tidak valid untuk ${file.name}. File dilewati.`, "error", '<span class="icon">‚ùå</span>');
                            allFilesProcessed = false;
                            return;
                        }
                    }

                    if (type === 'penghasilan') {
                        const summarySheet = workbook.Sheets['Summary'];
                        const incomeSheet = workbook.Sheets['Income'];
                        
                        if (!summarySheet || !incomeSheet) {
                            _display_message(statusElementId, `File Penghasilan '${file.name}' harus memiliki sheet 'Summary' dan 'Income'. Dilewati.`, "error", '<span class="icon">‚ùå</span>');
                            allFilesProcessed = false;
                            return;
                        }

                        const dfSummary = XLSX.utils.sheet_to_json(summarySheet, { header: 1 });
                        const dfIncomeRaw = XLSX.utils.sheet_to_json(incomeSheet, { header: 1 });
                        
                        // Find header row for Income sheet (row 6, 0-indexed)
                        let incomeHeaderRow = 5; // Assuming header is at 6th row (index 5)
                        if (dfIncomeRaw.length < incomeHeaderRow + 1) {
                            _display_message(statusElementId, `Sheet 'Income' di '${file.name}' terlalu pendek. Dilewati.`, "error", '<span class="icon">‚ùå</span>');
                            allFilesProcessed = false;
                            return;
                        }
                        const incomeHeaders = dfIncomeRaw[incomeHeaderRow];
                        const dfIncomeData = dfIncomeRaw.slice(incomeHeaderRow + 1);

                        const dfIncome = _create_dataframe(incomeHeaders, dfIncomeData);
                        
                        let incomeColName = null;
                        const commonIncomeCols = ["total penghasilan", "total pendapatan", "penghasilan", "pendapatan", "jumlah pendapatan", "jumlah penghasilan", "total penjualan", "pendapatan bersih"];
                        
                        for (const col of dfIncome.columns) {
                            if (commonIncomeCols.includes(col.toLowerCase().trim())) {
                                // Check if column is mostly numeric
                                const potentialNumericSeries = dfIncome.data.map(row => parseFloat(row[col]));
                                const numericCount = potentialNumericSeries.filter(val => !isNaN(val)).length;
                                if (numericCount / potentialNumericSeries.length >= 0.8) {
                                    incomeColName = col;
                                    break;
                                }
                            }
                        }

                        if (!incomeColName) {
                            const availableCols = dfIncome.columns.map((col, idx) => `${idx + 1}. ${col}`).join('\n');
                            let userInputCol = await _custom_prompt(`Deteksi otomatis kolom 'Total Penghasilan' gagal di '${file.name}'.\nKolom yang tersedia:\n${availableCols}\nMasukkan NAMA KOLOM atau NOMOR KOLOM untuk 'Total Penghasilan':`);
                            
                            if (userInputCol) {
                                const colIndex = parseInt(userInputCol, 10) - 1;
                                if (!isNaN(colIndex) && colIndex >= 0 && colIndex < dfIncome.columns.length) {
                                    incomeColName = dfIncome.columns[colIndex];
                                } else if (dfIncome.columns.includes(userInputCol)) {
                                    incomeColName = userInputCol;
                                }
                            }
                        }

                        if (incomeColName) {
                            _data_penghasilan[month] = { Summary: dfSummary, Income: dfIncome, income_col_name: incomeColName };
                            if (!_bulan_penghasilan.includes(month)) {
                                _bulan_penghasilan.push(month);
                                _bulan_penghasilan.sort((a, b) => _mo[a] - _mo[b]);
                            }
                            _display_message(statusElementId, `File Penghasilan '${file.name}' untuk bulan ${month} berhasil dimuat.`, "success", '<span class="icon">‚úÖ</span>');
                        } else {
                            _display_message(statusElementId, `Gagal menentukan kolom 'Total Penghasilan' untuk '${file.name}'. Dilewati.`, "error", '<span class="icon">‚ùå</span>');
                            allFilesProcessed = false;
                        }

                    } else if (type === 'order') {
                        const firstSheetName = workbook.SheetNames[0]; // Changed to index 0 for first sheet
                        const dfOrderRaw = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName], { header: 1 });
                        
                        if (dfOrderRaw.length < 1) {
                            _display_message(statusElementId, `File Order '${file.name}' kosong. Dilewati.`, "error", '<span class="icon">‚ö†Ô∏è</span>');
                            allFilesProcessed = false;
                            return;
                        }
                        const orderHeaders = dfOrderRaw[0];
                        const dfOrderData = dfOrderRaw.slice(1);
                        const dfOrder = _create_dataframe(orderHeaders, dfOrderData);

                        _data_order[month] = dfOrder;
                        if (!_bulan_order.includes(month)) {
                            _bulan_order.push(month);
                            _bulan_order.sort((a, b) => _mo[a] - _mo[b]);
                        }
                        _display_message(statusElementId, `File Order '${file.name}' untuk bulan ${month} berhasil dimuat.`, "success", '<span class="icon">‚úÖ</span>');
                    }
                } catch (error) {
                    _display_message(statusElementId, `Gagal memproses file '${file.name}': ${error.message}`, "error", '<span class="icon">‚ùå</span>');
                    allFilesProcessed = false;
                } finally {
                    _update_ui_state();
                }
            };
            reader.readAsArrayBuffer(file);
        }
        if (allFilesProcessed) {
            _display_message(statusElementId, `Semua file ${type} berhasil diproses.`, "success", '<span class="icon">üéâ</span>');
        }
    }

    // Custom prompt function to replace window.prompt for better UX
    function _custom_prompt(message) {
        return new Promise((resolve) => {
            const modalId = 'customPromptModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'login-overlay'; // Reuse overlay style
                modal.innerHTML = `
                    <div class="login-box">
                        <p id="customPromptMessage" class="text-lg mb-4 text-gray-700"></p>
                        <input type="text" id="customPromptInput" class="w-full p-2 border rounded mb-4" />
                        <button id="customPromptConfirm" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">OK</button>
                        <button id="customPromptCancel" class="w-full bg-gray-300 text-gray-800 p-2 rounded mt-2 hover:bg-gray-400">Batal</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('customPromptMessage').textContent = message;
            const input = document.getElementById('customPromptInput');
            input.value = ''; // Clear previous input
            modal.classList.remove('hidden');

            const confirmBtn = document.getElementById('customPromptConfirm');
            const cancelBtn = document.getElementById('customPromptCancel');

            const cleanup = () => {
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
                modal.classList.add('hidden');
            };

            confirmBtn.onclick = () => {
                resolve(input.value);
                cleanup();
            };

            cancelBtn.onclick = () => {
                resolve(null); // Return null if cancelled
                cleanup();
            };

            input.focus(); // Focus on the input field
        });
    }

    // Simple DataFrame-like object for basic operations
    function _create_dataframe(headers, data) {
        return {
            columns: headers.map(h => String(h).trim()),
            data: data.map(row => {
                const obj = {};
                headers.forEach((header, i) => {
                    obj[String(header).trim()] = row[i];
                });
                return obj;
            }),
            // Basic method to get unique values for a column
            get_unique_values(colName) {
                const values = new Set();
                this.data.forEach(row => {
                    if (row[colName] !== undefined && row[colName] !== null) {
                        values.add(String(row[colName]).trim());
                    }
                });
                return Array.from(values);
            },
            // Basic method to filter data
            filter(predicate) {
                return this.data.filter(predicate);
            },
            // Basic method to sum a column
            sum(colName) {
                return this.data.reduce((acc, row) => {
                    const val = parseFloat(row[colName]);
                    return acc + (isNaN(val) ? 0 : val);
                }, 0);
            },
            // Basic method to get unique count of a column
            nunique(colName) {
                const values = new Set();
                this.data.forEach(row => {
                    if (row[colName] !== undefined && row[colName] !== null) {
                        values.add(String(row[colName]).trim());
                    }
                });
                return values.size;
            },
            // Basic method to check if column exists
            has_column(colName) {
                return this.columns.includes(colName);
            }
        };
    }

    function _get_unique_products_from_all_orders() {
        const allProductsData = new Set();
        const requiredColumns = ["SKU Induk", "Nama Produk", "Nomor Referensi SKU", "Nama Variasi"];

        for (const month in _data_order) {
            const dfOrder = _data_order[month];
            
            const missingCols = requiredColumns.filter(col => !dfOrder.has_column(col));
            if (missingCols.length > 0) {
                console.warn(`Kolom identifikasi produk yang hilang di Dokumen Order bulan ${month}: ${missingCols.join(', ')}. Produk dari bulan ini mungkin tidak lengkap.`);
                continue;
            }

            dfOrder.data.forEach(row => {
                try {
                    const skuInduk = String(row['SKU Induk'] || '').trim();
                    const namaProduk = String(row['Nama Produk'] || '').trim();
                    const refSku = String(row['Nomor Referensi SKU'] || '').trim();
                    const variasi = String(row['Nama Variasi'] || '').trim();
                    const key = `${skuInduk} | ${namaProduk} | ${refSku} | ${variasi}`;
                    allProductsData.add(key);
                } catch (e) {
                    console.warn(`Peringatan: Gagal memproses baris produk unik: ${e}`);
                }
            });
        }
        return Array.from(allProductsData).sort();
    }

    function _get_eligible_months() {
        const eligibleMonths = [];
        const sortedPenghasilanMonths = [..._bulan_penghasilan].sort((a, b) => _mo[a] - _mo[b]);

        for (const currentMonth of sortedPenghasilanMonths) {
            if (!_data_penghasilan[currentMonth]) continue;
            if (!_data_order[currentMonth] || _data_order[currentMonth].data.length === 0) continue;

            const currentMonthNum = _mo[currentMonth];
            // For January, check if December order data exists
            if (currentMonthNum === 1) { 
                if (_data_order['Des'] && _data_order['Des'].data.length > 0) {
                    eligibleMonths.push(currentMonth);
                }
            } else { // For other months, check if previous month's order data exists
                const prevMonthNum = currentMonthNum - 1;
                const prevMonth = _rmo[prevMonthNum];
                if (prevMonth && _data_order[prevMonth] && _data_order[prevMonth].data.length > 0) {
                    eligibleMonths.push(currentMonth);
                }
            }
        }
        return eligibleMonths;
    }

    function _update_month_selects() {
        const months = _get_eligible_months();
        const analysisSelect = document.getElementById("analysisMonthSelect");
        const iklanMonthSelect = document.getElementById("iklanInputMonth");
        const operasionalMonthSelect = document.getElementById("operasionalInputMonth");

        [analysisSelect, iklanMonthSelect, operasionalMonthSelect].forEach(select => {
            select.innerHTML = '<option value="">Pilih Bulan</option>';
            // Add all available months from penghasilan/order/iklan/operasional for input selects
            const allAvailableMonths = new Set([..._bulan_penghasilan, ..._bulan_order, ..._bulan_iklan, ..._bulan_operasional]);
            const sortedAllMonths = Array.from(allAvailableMonths).sort((a, b) => _mo[a] - _mo[b]);

            const monthsToPopulate = (select.id === "analysisMonthSelect") ? months : sortedAllMonths;

            monthsToPopulate.forEach(month => {
                const option = document.createElement("option");
                option.value = month;
                option.textContent = _fmn[month];
                select.appendChild(option);
            });
        });

        // Enable/disable analysis buttons
        const hasEnoughDataForAnalysis = months.length > 0;
        document.getElementById("analyzeButton").disabled = !hasEnoughDataForAnalysis;
        document.getElementById("summaryButton").disabled = !hasEnoughDataForAnalysis;
        document.getElementById("exportButton").disabled = !hasEnoughDataForAnalysis;
        document.getElementById("hppButton").disabled = (Object.keys(_data_order).length === 0);
    }

    function _update_ui_state() {
        _update_month_selects();
    }

    async function inputBiaya(type) {
        const monthSelect = document.getElementById(`${type}InputMonth`);
        const amountInput = document.getElementById(`${type}InputAmount`);
        const statusElementId = `${type}Status`;

        const month = monthSelect.value;
        const amount = parseFloat(amountInput.value);

        if (!month) {
            _display_message(statusElementId, "Pilih bulan terlebih dahulu.", "error", '<span class="icon">‚ö†Ô∏è</span>');
            return;
        }
        if (isNaN(amount) || amount < 0) {
            _display_message(statusElementId, "Nominal tidak valid. Masukkan angka positif.", "error", '<span class="icon">‚ùå</span>');
            return;
        }

        if (type === 'iklan') {
            _data_iklan[month] = amount;
            if (!_bulan_iklan.includes(month)) {
                _bulan_iklan.push(month);
                _bulan_iklan.sort((a, b) => _mo[a] - _mo[b]);
            }
        } else if (type === 'operasional') {
            _data_operasional[month] = amount;
            if (!_bulan_operasional.includes(month)) {
                _bulan_operasional.push(month);
                _bulan_operasional.sort((a, b) => _mo[a] - _mo[b]);
            }
        }
        _display_message(statusElementId, `Biaya ${type} untuk ${month} sebesar Rp ${amount.toLocaleString('id-ID')} berhasil disimpan.`, "success", '<span class="icon">‚úÖ</span>');
        amountInput.value = '';
        _update_ui_state();
    }

    async function inputHPPProduk() {
        const hppStatus = document.getElementById("hppStatus");
        if (Object.keys(_data_order).length === 0) {
            _display_message(hppStatus, "Belum ada Dokumen Order yang diinput. Harap input Dokumen Order terlebih dahulu.", "error", '<span class="icon">‚ö†Ô∏è</span>');
            return;
        }

        const uniqueProducts = _get_unique_products_from_all_orders();
        if (uniqueProducts.length === 0) {
            _display_message(hppStatus, "Tidak ada produk unik yang ditemukan di Dokumen Order yang dimuat.", "info", '<span class="icon">‚ÑπÔ∏è</span>');
            return;
        }

        let allHPPEntered = true;
        for (const productKey of uniqueProducts) {
            const currentHPP = _data_hpp[productKey];
            let promptText = `Masukkan HPP untuk produk:\n${productKey}`;
            if (currentHPP !== undefined) {
                promptText += ` (HPP saat ini: Rp ${currentHPP.toLocaleString('id-ID')})`;
            }
            
            let hppInput = await _custom_prompt(promptText + "\n(atau kosongkan untuk lewati)");
            if (hppInput === null) { // User cancelled
                allHPPEntered = false;
                break;
            }
            hppInput = hppInput.trim();

            if (hppInput === "") {
                console.log(`HPP untuk ${productKey} dilewati.`);
                continue;
            }

            const hppValue = parseFloat(hppInput.replace(/[^0-9,-]+/g, "").replace(",", ".")); // Clean input
            if (isNaN(hppValue) || hppValue < 0) {
                _display_message(hppStatus, `Input HPP tidak valid untuk ${productKey}. Dilewati.`, "error", '<span class="icon">‚ùå</span>');
                allHPPEntered = false;
                continue;
            }
            _data_hpp[productKey] = hppValue;
        }

        if (allHPPEntered) {
            _display_message(hppStatus, "Input HPP produk selesai.", "success", '<span class="icon">‚úÖ</span>');
        } else {
            _display_message(hppStatus, "Beberapa input HPP dilewati atau tidak valid.", "info", '<span class="icon">‚ÑπÔ∏è</span>');
        }
        _update_ui_state();
    }

    function resetAllData() {
        if (confirm("Apakah Anda yakin ingin mereset semua data yang dimuat (penghasilan, order, biaya, HPP)? Tindakan ini tidak dapat dibatalkan.")) {
            _data_penghasilan = {};
            _data_order = {};
            _data_iklan = {};
            _data_operasional = {};
            _data_hpp = {};
            _bulan_penghasilan = [];
            _bulan_order = [];
            _bulan_iklan = [];
            _bulan_operasional = [];
            
            document.getElementById("penghasilanFileInput").value = '';
            document.getElementById("orderFileInput").value = '';
            document.getElementById("iklanInputAmount").value = '';
            document.getElementById("operasionalInputAmount").value = '';
            document.getElementById("analysisOutput").classList.add("hidden");

            _update_ui_state();
            _display_message("analysisOutput", "Semua data berhasil direset.", "info", '<span class="icon">üîÑ</span>');
        }
    }

    function _hitung_metrik(month) {
        let totalPendapatanSummary = 0;
        let biayaAdminLayanan = 0;
        let totalPenghasilanIncome = 0;
        let totalHPP = 0;
        let biayaOperasional = _data_operasional[month] || 0;
        let biayaIklan = _data_iklan[month] || 0;
        let totalItemTerjualForBasketSize = 0;
        let jumlahOrderUnikFromIncome = 0;

        console.log(`--- Perhitungan Metrik untuk Bulan: ${month} ---`);

        // Get data from _data_penghasilan
        if (_data_penghasilan[month]) {
            const dfSummary = _data_penghasilan[month].Summary;
            const dfIncome = _data_penghasilan[month].Income;
            const incomeColName = _data_penghasilan[month].income_col_name;

            console.log("[DEBUG] Data Penghasilan (Summary):", dfSummary);
            console.log("[DEBUG] Data Penghasilan (Income):", dfIncome);
            console.log("[DEBUG] Kolom Penghasilan Terdeteksi:", incomeColName);

            // Extract from Summary (assuming fixed cells for simplicity, adapt if needed)
            try {
                // For Summary sheet, assuming it's a simple 2D array from XLSX.utils.sheet_to_json(..., {header:1})
                // D11 is row 10, col 3 (0-indexed)
                totalPendapatanSummary = parseFloat(dfSummary[10]?.[3]) || 0;
                console.log("[DEBUG] totalPendapatanSummary (dari D11):", totalPendapatanSummary);
            } catch (e) {
                console.warn(`Error reading D11 from Summary for ${month}: ${e.message}. Using 0.`);
                totalPendapatanSummary = 0;
            }
            try {
                // D22 is row 21, col 3 (0-indexed)
                biayaAdminLayanan = parseFloat(dfSummary[21]?.[3]) || 0;
                console.log("[DEBUG] biayaAdminLayanan (dari D22):", biayaAdminLayanan);
            } catch (e) {
                console.warn(`Error reading D22 from Summary for ${month}: ${e.message}. Using 0.`);
                biayaAdminLayanan = 0;
            }

            // Extract from Income
            if (incomeColName && dfIncome.has_column(incomeColName)) {
                totalPenghasilanIncome = dfIncome.sum(incomeColName);
                console.log("[DEBUG] totalPenghasilanIncome (sum dari kolom Income):", totalPenghasilanIncome);
            } else {
                console.warn(`Kolom '${incomeColName}' tidak ditemukan di sheet Income untuk ${month}. Menggunakan 0.`);
                totalPenghasilanIncome = 0;
            }

            if (dfIncome.has_column(ORDER_ID_COL)) {
                jumlahOrderUnikFromIncome = dfIncome.nunique(ORDER_ID_COL);
                console.log("[DEBUG] jumlahOrderUnikFromIncome:", jumlahOrderUnikFromIncome);
            } else {
                console.warn(`Kolom '${ORDER_ID_COL}' tidak ditemukan di sheet Income untuk ${month}. Menggunakan 0 untuk order unik.`);
                jumlahOrderUnikFromIncome = 0;
            }
        } else {
            console.warn(`Data penghasilan tidak lengkap untuk bulan ${month}.`);
        }

        console.log("[DEBUG] Biaya Operasional Input:", biayaOperasional);
        console.log("[DEBUG] Biaya Iklan Input:", biayaIklan);

        // Calculate HPP based on orders and HPP data
        const currentMonthOrderDf = _data_order[month];
        if (currentMonthOrderDf && Object.keys(_data_hpp).length > 0) {
            const relevantOrderData = currentMonthOrderDf.data; // Use all data from current month's order sheet
            console.log("[DEBUG] Data Order untuk HPP:", relevantOrderData);
            console.log("[DEBUG] Data HPP Produk:", _data_hpp);

            for (const row of relevantOrderData) {
                try {
                    const skuInduk = String(row['SKU Induk'] || '').trim();
                    const namaProduk = String(row['Nama Produk'] || '').trim();
                    const refSku = String(row['Nomor Referensi SKU'] || '').trim();
                    const variasi = String(row['Nama Variasi'] || '').trim();
                    const productKey = `${skuInduk} | ${namaProduk} | ${refSku} | ${variasi}`;
                    const quantity = parseFloat(row[QUANTITY_COL]);

                    if (!isNaN(quantity) && quantity > 0) {
                        totalItemTerjualForBasketSize += quantity;
                        const hppProduk = _data_hpp[productKey];
                        if (hppProduk !== undefined) {
                            totalHPP += (hppProduk * quantity);
                            console.log(`[DEBUG] HPP untuk ${productKey} (Qty: ${quantity}, HPP/unit: ${hppProduk}) = ${hppProduk * quantity}. Total HPP saat ini: ${totalHPP}`);
                        } else {
                            console.warn(`HPP tidak ditemukan untuk produk: '${productKey}'. Dianggap 0 untuk item ini.`);
                        }
                    }
                } catch (e) {
                    console.warn(`Error processing order row for HPP calculation: ${e.message}`, row);
                }
            }
            console.log("[DEBUG] Total HPP Terhitung:", totalHPP);
            console.log("[DEBUG] Total Item Terjual (untuk Basket Size):", totalItemTerjualForBasketSize);
        } else {
            console.warn(`Data order atau HPP tidak lengkap untuk perhitungan HPP bulan ${month}.`);
        }

        const labaKotor = totalPendapatanSummary - totalHPP;
        const labaBersih = totalPenghasilanIncome - totalHPP - biayaOperasional - biayaIklan;

        console.log("[DEBUG] Laba Kotor:", labaKotor);
        console.log("[DEBUG] Laba Bersih:", labaBersih);

        const rasioAdminLayanan = (totalPendapatanSummary > 0) ? (Math.abs(biayaAdminLayanan) / totalPendapatanSummary) * 100 : 0;
        const rasioOperasional = (totalPendapatanSummary > 0) ? ((biayaOperasional + biayaIklan) / totalPendapatanSummary) * 100 : 0;
        const aovAktual = (jumlahOrderUnikFromIncome > 0) ? totalPenghasilanIncome / jumlahOrderUnikFromIncome : 0;
        const basketSizeAktual = (jumlahOrderUnikFromIncome > 0) ? totalItemTerjualForBasketSize / jumlahOrderUnikFromIncome : 0;
        const roasAktual = (biayaIklan > 0) ? totalPendapatanSummary / biayaIklan : 0;
        const acosAktual = (totalPendapatanSummary > 0) ? (biayaIklan / totalPendapatanSummary) * 100 : 0;
        const rasioMargin = (totalPendapatanSummary > 0) ? (labaKotor / totalPendapatanSummary) * 100 : 0;
        const rasioLaba = (totalPendapatanSummary > 0) ? (labaBersih / totalPendapatanSummary) * 100 : 0;

        console.log("[DEBUG] Rasio Admin & Layanan:", rasioAdminLayanan);
        console.log("[DEBUG] Rasio Operasional:", rasioOperasional);
        console.log("[DEBUG] AOV Aktual:", aovAktual);
        console.log("[DEBUG] Basket Size Aktual:", basketSizeAktual);
        console.log("[DEBUG] ROAS Aktual:", roasAktual);
        console.log("[DEBUG] ACOS Aktual:", acosAktual);
        console.log("[DEBUG] Rasio Margin:", rasioMargin);
        console.log("[DEBUG] Rasio Laba:", rasioLaba);
        console.log("[DEBUG] Status Laba:", labaBersih >= 0 ? "LABA" : "RUGI");
        console.log("--- Akhir Perhitungan Metrik ---");


        return {
            "TOTAL PENDAPATAN (SUMMARY)": totalPendapatanSummary,
            "TOTAL PENGHASILAN (INCOME)": totalPenghasilanIncome,
            "HPP": totalHPP,
            "BIAYA OPERASIONAL": biayaOperasional,
            "BIAYA IKLAN": biayaIklan,
            "LABA KOTOR": labaKotor,
            "LABA BERSIH": labaBersih,
            "RASIO ADMIN & LAYANAN": rasioAdminLayanan,
            "RASIO OPERASIONAL": rasioOperasional,
            "AOV AKTUAL": aovAktual,
            "BASKET SIZE AKTUAL": basketSizeAktual,
            "ROAS AKTUAL": roasAktual,
            "ACOS AKTUAL": acosAktual,
            "RASIO MARGIN": rasioMargin,
            "RASIO LABA": rasioLaba,
            "STATUS LABA": labaBersih >= 0 ? "LABA" : "RUGI"
        };
    }

    function displaySingleMonthAnalysis() {
        const month = document.getElementById("analysisMonthSelect").value;
        const outputDiv = document.getElementById("analysisOutput");
        outputDiv.classList.add("hidden"); // Hide previous output

        if (!month) {
            _display_message("analysisOutput", "Pilih bulan untuk analisis.", "error", '<span class="icon">‚ö†Ô∏è</span>');
            return;
        }

        const results = _hitung_metrik(month);
        const fullMonthName = _fmn[month];

        let html = `
            <h3 class="text-xl font-semibold text-center text-gray-700 mb-4">Analisis Keuangan Bulan ${fullMonthName}</h3>
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4">Metrik</th>
                        <th class="py-2 px-4">Nilai</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (const key in results) {
            let value = results[key];
            let formattedValue = value;
            let rowClass = '';
            let icon = '';

            if (typeof value === 'number') {
                if (key.includes("PERSEN") || key.includes("%") || key.includes("RASIO") || key.includes("ACOS") || key.includes("MARGIN") || key.includes("LABA")) {
                    formattedValue = `${value.toFixed(2)}%`;
                } else if (key.includes("ROAS")) {
                    formattedValue = `${value.toFixed(2)}x`;
                } else if (key.includes("BASKET SIZE")) {
                    formattedValue = `${value.toFixed(2)} item/order`;
                } else {
                    formattedValue = `Rp ${value.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                }
            } else if (key === "STATUS LABA") {
                formattedValue = value;
                if (value === "LABA") {
                    rowClass = 'text-green-600 font-bold';
                    icon = '‚úÖ';
                } else {
                    rowClass = 'text-red-600 font-bold';
                    icon = '‚õî';
                }
            }

            html += `
                <tr class="${rowClass}">
                    <td class="py-2 px-4">${_scm[key] || key}</td>
                    <td class="py-2 px-4">${icon} ${formattedValue}</td>
                </tr>
            `;
        }

        html += `
                </tbody>
            </table>
        `;
        outputDiv.innerHTML = html;
        outputDiv.classList.remove("hidden");
    }

    function displayAllMonthsSummary() {
        const outputDiv = document.getElementById("analysisOutput");
        outputDiv.classList.add("hidden"); // Hide previous output

        const eligibleMonths = _get_eligible_months();
        if (eligibleMonths.length === 0) {
            _display_message("analysisOutput", "Belum ada bulan yang memenuhi syarat untuk dianalisis.", "error", '<span class="icon">‚ö†Ô∏è</span>');
            return;
        }

        const allMonthsData = [];
        for (const month of eligibleMonths) {
            const metrics = _hitung_metrik(month);
            metrics['Bulan'] = _fmn[month]; // Add full month name for display
            allMonthsData.push(metrics);
        }

        if (allMonthsData.length === 0) {
            _display_message("analysisOutput", "Tidak ada data yang tersedia untuk ditampilkan dalam tabel ringkasan.", "info", '<span class="icon">‚ÑπÔ∏è</span>');
            return;
        }

        // Prepare columns and headers
        const columns = [
            "Bulan", "TOTAL PENDAPATAN (SUMMARY)", "TOTAL PENGHASILAN (INCOME)", "HPP",
            "BIAYA OPERASIONAL", "BIAYA IKLAN", "LABA KOTOR", "LABA BERSIH",
            "RASIO ADMIN & LAYANAN", "RASIO OPERASIONAL", "AOV AKTUAL", "BASKET SIZE AKTUAL",
            "ROAS AKTUAL", "ACOS AKTUAL", "RASIO MARGIN", "RASIO LABA", "STATUS LABA"
        ];
        
        let html = `
            <h3 class="text-xl font-semibold text-center text-gray-700 mb-4">Ringkasan Analisis Keuangan Semua Bulan</h3>
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
        `;
        for (const col of columns) {
            html += `<th class="py-2 px-4">${_scm[col] || col}</th>`;
        }
        html += `
                    </tr>
                </thead>
                <tbody>
        `;

        for (const rowData of allMonthsData) {
            html += '<tr>';
            for (const col of columns) {
                let value = rowData[col];
                let formattedValue = value;
                let cellClass = '';
                let icon = '';

                if (typeof value === 'number') {
                    if (col.includes("PERSEN") || col.includes("%") || col.includes("RASIO") || col.includes("ACOS") || col.includes("MARGIN") || col.includes("LABA")) {
                        formattedValue = `${value.toFixed(2)}%`;
                    } else if (col.includes("ROAS")) {
                        formattedValue = `${value.toFixed(2)}x`;
                    } else if (col.includes("BASKET SIZE")) {
                        formattedValue = `${value.toFixed(2)}`;
                    } else {
                        formattedValue = `Rp ${value.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                    }
                } else if (col === "STATUS LABA") {
                    formattedValue = value;
                    if (value === "LABA") {
                        cellClass = 'text-green-600 font-bold';
                        icon = '‚úÖ';
                    } else {
                        cellClass = 'text-red-600 font-bold';
                        icon = '‚õî';
                    }
                }

                html += `<td class="py-2 px-4 ${cellClass}">${icon} ${formattedValue}</td>`;
            }
            html += '</tr>';
        }

        html += `
                </tbody>
            </table>
        `;
        outputDiv.innerHTML = html;
        outputDiv.classList.remove("hidden");
    }

    async function exportReports() {
        const eligibleMonths = _get_eligible_months();
        if (eligibleMonths.length === 0) {
            _display_message("analysisOutput", "Belum ada bulan yang memenuhi syarat untuk diekspor.", "error", '<span class="icon">‚ö†Ô∏è</span>');
            return;
        }

        const exportChoice = await _custom_prompt("Pilih jenis ekspor:\n1. Ekspor Laporan Bulan Spesifik\n2. Ekspor Laporan Semua Bulan ke Satu File\n(Masukkan 1 atau 2)");

        if (exportChoice === '1') {
            const monthNames = eligibleMonths.map(m => _fmn[m]).join(', ');
            const monthToExportInput = await _custom_prompt(`Bulan yang tersedia: ${monthNames}\nMasukkan bulan yang ingin diekspor (misal: Jan, Februari):`);
            const normalizedMonth = _normalize_month_input(monthToExportInput);

            if (normalizedMonth && eligibleMonths.includes(normalizedMonth)) {
                const singleMonthAnalysisData = _hitung_metrik(normalizedMonth);
                _export_to_excel(singleMonthAnalysisData, "single", normalizedMonth);
            } else {
                _display_message("analysisOutput", "Bulan tidak valid atau tidak tersedia untuk analisis.", "error", '<span class="icon">‚ùå</span>');
            }
        } else if (exportChoice === '2') {
            const allMonthsAnalysisData = {};
            for (const month of eligibleMonths) {
                allMonthsAnalysisData[month] = _hitung_metrik(month);
            }
            _export_to_excel(allMonthsAnalysisData, "all");
        } else {
            _display_message("analysisOutput", "Pilihan tidak valid.", "error", '<span class="icon">‚ùå</span>');
        }
    }

    function _export_to_excel(data, exportType, monthName = null) {
        const wb = XLSX.utils.book_new();
        let ws;
        let fileName = "Laporan_Keuangan";

        if (exportType === "single") {
            const fullMonthName = _fmn[monthName];
            fileName = `Laporan_Keuangan_${fullMonthName}.xlsx`;
            const rows = Object.keys(data).map(key => [_scm[key] || key, data[key]]);
            ws = XLSX.utils.aoa_to_sheet([["Metrik", "Nilai"], ...rows]);
        } else if (exportType === "all") {
            fileName = "Laporan_Keuangan_Semua_Bulan.xlsx";
            const allDataForDf = [];
            const sortedMonths = Object.keys(data).sort((a, b) => _mo[a] - _mo[b]);
            for (const month of sortedMonths) {
                const metrics = data[month];
                const rowData = {};
                for (const key in metrics) {
                    rowData[_scm[key] || key] = metrics[key];
                }
                rowData["Bulan"] = _fmn[month];
                allDataForDf.push(rowData);
            }
            // Ensure consistent column order for all months
            const columns = [
                "Bulan", "PENDAPATAN", "PENGHASILAN", "HPP", "OPERASIONAL", "IKLAN",
                "LABA KOTOR", "LABA BERSIH", "ADM & LYN %", "OPS %", "AOV", "BASKET SIZE",
                "ROAS", "ACOS", "MARGIN %", "LABA %", "STATUS"
            ];
            ws = XLSX.utils.json_to_sheet(allDataForDf, { header: columns });
        }

        XLSX.utils.book_append_sheet(wb, ws, monthName ? _fmn[monthName] : "Ringkasan");
        XLSX.writeFile(wb, fileName);
        _display_message("analysisOutput", `Laporan berhasil diekspor sebagai ${fileName}`, "success", '<span class="icon">‚úÖ</span>');
    }

    // --- Initialization ---
    function _init_app() {
        _update_ui_state();
    }

    // Initial license check on page load
    window.onload = _init_license_check;

    // Expose global functions for HTML onclick
    window.handleFileInput = handleFileInput;
    window.inputBiaya = inputBiaya;
    window.inputHPPProduk = inputHPPProduk;
    window.displaySingleMonthAnalysis = displaySingleMonthAnalysis;
    window.displayAllMonthsSummary = displayAllMonthsSummary;
    window.exportReports = exportReports;
    window.verifyLicense = verifyLicense; // Expose verifyLicense for the button
    window.resetAllData = resetAllData; // Expose reset function
})();
    </script>
</body>
</html>
