<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>By Leemood | Panel Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #95a5a6;
            --background-light: #f4f7f6;
            --background-gradient-start: #f0f4f8;
            --background-gradient-end: #d9e2ec;
            --card-background: #ffffff;
            --text-color: #333;
            --border-color: #e0e0e0;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --button-hover-transform: translateY(-2px);
            --button-transition: all 0.2s ease-in-out;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--background-gradient-start), var(--background-gradient-end));
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .login-container {
            background: var(--card-background);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 40px var(--shadow-medium);
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-container h2 {
            font-size: 2.2rem;
            margin-bottom: 30px;
            color: var(--secondary-color);
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--secondary-color);
            font-size: 0.95rem;
        }

        .input-group input {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-color);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .input-group input::placeholder {
            color: #ccc;
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--button-transition);
            box-shadow: 0 5px 15px var(--shadow-light);
            letter-spacing: 0.5px;
        }

        .login-button:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--shadow-medium);
        }

        .login-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-size: 0.9rem;
            font-weight: 500;
            display: none;
        }

        .admin-panel {
            display: none;
            width: 100%;
            flex-grow: 1;
            flex-direction: column;
        }

        .landing {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px 20px;
            flex-direction: column;
            text-align: center;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 25px;
            font-weight: 700;
            color: var(--secondary-color);
            letter-spacing: -0.5px;
        }

        .menu {
            display: flex;
            flex-direction: row;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .menu a {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 28px;
            text-decoration: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            min-width: 180px;
            text-align: center;
            transition: var(--button-transition);
            box-shadow: 0 4px 10px var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .menu a:hover {
            background-color: #2980b9;
            transform: var(--button-hover-transform);
            box-shadow: 0 6px 15px var(--shadow-medium);
        }

        .menu a:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        .container {
            max-width: 960px;
            margin: 30px auto;
            background: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-medium);
        }

        .admin-panel h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--secondary-color);
            font-size: 2rem;
            font-weight: 600;
        }

        .form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: end;
        }

        .search-group {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-group input {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .search-group button {
            flex-shrink: 0;
            padding: 0.8rem 1.2rem;
            background-color: var(--info-color);
        }
        .search-group button:hover {
            background-color: #7f8c8d;
        }


        .form input::placeholder {
            color: #aaa;
        }

        .form input {
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            color: var(--text-color);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .form button {
            padding: 0.8rem;
            border-radius: 8px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: var(--button-transition);
            font-weight: 600;
            letter-spacing: 0.5px;
            width: auto;
            box-shadow: 0 4px 8px var(--shadow-light);
        }

        .form button:hover {
            background-color: #27ae60;
            transform: var(--button-hover-transform);
            box-shadow: 0 6px 12px var(--shadow-medium);
        }

        .form button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        .generated-pass {
            margin-top: 1rem;
            padding: 0.8rem;
            background-color: #e6ffe6;
            border: 1px solid #c6f6d5;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-color);
            text-align: center;
            grid-column: 1 / -1;
            word-break: break-all;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), var(--border-color), rgba(0, 0, 0, 0));
            margin: 2.5rem 0;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px var(--shadow-light);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 700px;
        }

        th, td {
            padding: 1rem 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            word-break: break-word;
        }

        th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th:first-child { border-top-left-radius: 10px; }
        th:last-child { border-top-right-radius: 10px; }

        tr:last-child td { border-bottom: none; }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tbody tr:hover {
            background-color: #eef7ff;
            transition: background-color 0.2s ease;
        }

        td button {
            padding: 0.6rem 0.9rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 8px;
            transition: var(--button-transition);
            font-weight: 500;
            min-width: auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        td button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }

        td button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        td button:nth-of-type(1) {
            background-color: var(--primary-color);
            color: white;
        }
        td button:nth-of-type(1):hover { background-color: #2980b9; }

        td button:nth-of-type(2) {
            background-color: var(--danger-color);
            color: white;
        }
        td button:nth-of-type(2):hover { background-color: #c0392b; }

        td button:nth-of-type(3) {
            background-color: var(--warning-color);
            color: white;
        }
        td button:nth-of-type(3):hover { background-color: #d39e00; }

        td button:nth-of-type(4) {
            background-color: var(--info-color);
            color: white;
        }
        td button:nth-of-type(4):hover { background-color: #7f8c8d; }

        .form input.flatpickr-input,
        td input.flatpickr-input,
        .user-card input.flatpickr-input {
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            color: var(--text-color);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: white;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none; 
            padding-right: 0.8rem;
        }

        .form input.flatpickr-input:focus,
        td input.flatpickr-input:focus,
        .user-card input.flatpickr-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .card-container {
            display: none;
            flex-direction: column;
            gap: 1.2rem;
            margin-top: 1.5rem;
        }

        .user-card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            background: var(--card-background);
            box-shadow: 0 4px 12px var(--shadow-light);
            transition: var(--button-transition);
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px var(--shadow-medium);
        }

        .user-card div {
            margin-bottom: 0.7rem;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-card div strong {
            color: var(--secondary-color);
            min-width: 90px;
            flex-shrink: 0;
            margin-right: 10px;
        }
        
        .user-card button {
            margin-top: 10px;
            width: 100%;
            font-size: 1rem;
            padding: 0.8rem;
            border-radius: 25px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            transition: var(--button-transition);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .user-card button:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .user-card button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .user-card button:first-of-type {
            background-color: var(--primary-color);
            color: white;
        }
        .user-card button:first-of-type:hover { background-color: #2980b9; }

        .user-card button:nth-of-type(2) {
            background-color: var(--warning-color);
            color: white;
        }
        .user-card button:nth-of-type(2):hover { background-color: #d39e00; }

        .user-card button:nth-of-type(3) {
            background-color: var(--info-color);
            color: white;
        }
        .user-card button:nth-of-type(3):hover { background-color: #7f8c8d; }

        .user-card button:last-of-type {
            background-color: var(--danger-color);
            color: white;
        }
        .user-card button:last-of-type:hover { background-color: #c0392b; }


        .pagination {
            text-align: center;
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .pagination button {
            padding: 0.7rem 1.5rem;
            font-size: 1rem;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--button-transition);
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .pagination button:hover {
            background-color: #1a252f;
            transform: var(--button-hover-transform);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .pagination button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .pagination button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        #pageInfo {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }

        .flatpickr-calendar {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px var(--shadow-medium);
            border-radius: 8px;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            z-index: 9999;
        }

        .flatpickr-months .flatpickr-month {
            background: var(--secondary-color);
            color: white;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months .flatpickr-month,
        .flatpickr-current-month .numInputWrapper {
            color: white;
        }

        .flatpickr-prev-month,
        .flatpickr-next-month {
            color: white;
            fill: white;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .flatpickr-prev-month:hover,
        .flatpickr-next-month:hover {
            opacity: 1;
        }

        .flatpickr-weekdays {
            background: #f0f0f0;
            border-bottom: 1px solid var(--border-color);
        }

        .flatpickr-weekday {
            color: var(--secondary-color);
            font-weight: 500;
            padding: 8px 0;
        }

        .flatpickr-day {
            color: var(--text-color);
            border-radius: 6px;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange,
        .flatpickr-day.selected.inRange,
        .flatpickr-day.startRange.endRange {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .flatpickr-day.today {
            border-color: var(--accent-color);
            color: var(--accent-color);
            font-weight: 600;
        }

        .flatpickr-day.today:hover {
            background: var(--accent-color);
            color: white;
        }

        .flatpickr-day.disabled,
        .flatpickr-day.nextMonthDay,
        .flatpickr-day.prevMonthDay {
            color: #ccc;
        }

        .flatpickr-time input.flatpickr-hour,
        .flatpickr-time input.flatpickr-minute,
        .flatpickr-time input.flatpickr-second {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px;
        }

        .flatpickr-time .flatpickr-am-pm {
            color: var(--secondary-color);
        }


        @media (max-width: 768px) {
            body {
                padding: 0 10px;
            }
            .admin-panel h1 { font-size: 2.2rem; margin-bottom: 20px;}
            .admin-panel h2 { font-size: 1.8rem; margin-bottom: 20px;}
            .menu { flex-direction: column; gap: 10px; }
            .menu a { 
                width: 90%;
                max-width: 300px; 
                margin: 0 auto;
                font-size: 1rem;
                padding: 10px 20px;
            }
            .form { 
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            .form input, .form button { 
                width: 100%;
                box-sizing: border-box;
            }
            .container { 
                padding: 1.2rem;
                margin: 20px auto;
                border-radius: 10px;
            }
            
            .table-container { 
                display: none; 
            }
            .card-container { 
                display: flex; 
            }

            .user-card {
                padding: 1rem;
                border-radius: 10px;
            }
            .user-card div {
                font-size: 0.95rem;
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 0.5rem;
            }
            .user-card div strong {
                min-width: unset;
                margin-right: 0;
                margin-bottom: 5px;
            }
            .user-card input.flatpickr-input {
                width: 100%;
                box-sizing: border-box;
            }
            .user-card button {
                padding: 0.7rem;
                font-size: 0.95rem;
                border-radius: 20px;
                margin-bottom: 5px;
            }
            .pagination {
                gap: 10px;
            }
            .pagination button { 
                padding: 0.6rem 1.2rem; 
                font-size: 0.9rem; 
            }
            #pageInfo { font-size: 0.95rem; }

            .search-group {
                flex-direction: column;
                gap: 0.8rem;
            }
            .search-group input, .search-group button {
                width: 100%;
                box-sizing: border-box;
            }
        }

        @media (max-width: 480px) {
            .login-container {
                padding: 30px 20px;
                width: 95%;
            }
            .login-container h2 {
                font-size: 1.8rem;
                margin-bottom: 25px;
            }
            .input-group input {
                padding: 10px;
                font-size: 0.95rem;
            }
            .login-button {
                padding: 12px;
                font-size: 1rem;
            }

            .admin-panel h1 { font-size: 1.8rem; }
            .admin-panel h2 { font-size: 1.5rem; }
            .container { padding: 1rem; margin: 15px auto; }
            .user-card { padding: 0.8rem; }
            .user-card div { font-size: 0.85rem; }
            .user-card button { font-size: 0.85rem; padding: 0.6rem; border-radius: 18px; }
            .pagination button { padding: 0.5rem 1rem; font-size: 0.85rem; }
            #pageInfo { font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <h2>Login Admin</h2>
        <div class="input-group">
            <label for="loginUsername">Username</label>
            <input type="text" id="loginUsername" placeholder="Masukkan Username" autocomplete="username">
        </div>
        <div class="input-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" placeholder="Masukkan Password" autocomplete="current-password">
        </div>
        <button class="login-button" onclick="handleLogin()">Login</button>
        <p id="errorMessage" class="error-message">Username atau password salah!</p>
    </div>

    <div class="admin-panel" id="adminPanel">
        <div class="landing">
            <h1>By Leemood</h1>
            <div class="menu">
                <a href="kalkulator roas.html">📈 Kalkulator ROAS</a>
                <a href="rasio keuangan.html">💰 Rasio Keuangan</a>
                <button onclick="logout()" style="background-color: var(--danger-color); color: white; border: none; padding: 12px 28px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; min-width: 180px; text-align: center; transition: var(--button-transition); box-shadow: 0 4px 10px var(--shadow-light);">Logout</button>
            </div>
        </div>

        <div class="container">
            <h2>Admin Firebase</h2>
            <div class="form">
                <input type="text" id="usernameInput" placeholder="Nama Pengguna" />
                <input type="text" id="expire" class="flatpickr-input" placeholder="Pilih Tanggal Expired" readonly="readonly" />
                <button onclick="tambahUser()">➕ Tambah Pengguna</button>
                <div id="generatedLicenseCode" class="generated-pass"></div>
                <div class="search-group">
                    <input type="text" id="searchUser" placeholder="Cari Nama Pengguna atau Kode Lisensi..." />
                    <button onclick="searchUsers()">🔍 Cari</button>
                </div>
            </div>
            <hr />
            <div class="users">
                <div class="table-container">
                    <table>
                        <thead><tr><th>Nama Pengguna</th><th>Kode Lisensi</th><th>Status</th><th>Expired</th><th>Aksi</th></tr></thead>
                        <tbody id="userBody"></tbody>
                    </table>
                </div>
                <div class="card-container" id="cardBody"></div>
                <div class="pagination">
                    <button onclick="prevPage()">⬅ Sebelumnya</button>
                    <span id="pageInfo">Halaman 1</span>
                    <button onclick="nextPage()">Berikutnya ➡</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/id.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>

    <script>
(function() {
    const _u_b64 = "bGFiaWJsZWVtb29k";
    const _p_b64 = "ZW1iaGVt";

    // Fungsi untuk decode Base64
    function _atob(str) {
        try {
            return atob(str);
        } catch (e) {
            console.error("Base64 decoding error:", e);
            return ""; // Return empty string on error
        }
    }

    const _u = _atob(_u_b64); // Decode username
    const _p = _atob(_p_b64); // Decode password

    const _u_db = "https://rasiokeuangan-b4c88-default-rtdb.asia-southeast1.firebasedatabase.app/users.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv";
    const _l_db = "https://rasiokeuangan-b4c88-default-rtdb.asia-southeast1.firebasedatabase.app/licenses";
    let _a = []; let _d = []; let _c = 1; const _pp = 50;

    // Anti-debugging: Infinite loop if debugger is open
    // This is a basic form and can be bypassed.
    // console.log("Debugging check active.");
    // const _ad = new Date();
    // setInterval(() => {
    //     if (new Date() - _ad > 100) {
    //         // debugger; // Uncommenting this will trigger debugger if open
    //     }
    // }, 1000);

    // Anti-debugging: Check console state (less reliable)
    // const _co = console;
    // Object.defineProperty(_co, 'log', {
    //     get: function() {
    //         if (arguments.callee.caller && arguments.callee.caller.toString().indexOf('debugger') !== -1) {
    //             // debugger;
    //         }
    //         return _co.log;
    //     }
    // });

    function _hL() {
        const uI = document.getElementById("loginUsername").value;
        const pI = document.getElementById("loginPassword").value;
        const eM = document.getElementById("errorMessage");
        const lC = document.getElementById("loginContainer");
        const aP = document.getElementById("adminPanel");
        if (uI === _u && pI === _p) {
            sessionStorage.setItem("isLoggedIn", "true");
            sessionStorage.setItem("lastActivityTime", new Date().toISOString());
            lC.style.display = "none";
            aP.style.display = "flex";
            _lU();
        } else {
            eM.style.display = "block";
            setTimeout(() => { eM.style.display = "none"; }, 3000);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const lUF = document.getElementById("loginUsername");
        const lPF = document.getElementById("loginPassword");
        const lC = document.getElementById("loginContainer");
        const aP = document.getElementById("adminPanel");
        const iL = sessionStorage.getItem("isLoggedIn");
        const lAT = sessionStorage.getItem("lastActivityTime");

        if (iL === "true" && lAT) {
            const lAD = new Date(lAT);
            const n = new Date();
            const oD = 24 * 60 * 60 * 1000;
            if (n.getTime() - lAD.getTime() > oD) {
                sessionStorage.removeItem("isLoggedIn");
                sessionStorage.removeItem("lastActivityTime");
                location.reload();
            } else {
                lC.style.display = "none";
                aP.style.display = "flex";
                _lU();
                sessionStorage.setItem("lastActivityTime", n.toISOString());
            }
        } else {
            lC.style.display = "flex";
            aP.style.display = "none";
        }

        if (lUF) { lUF.addEventListener("keypress", function(e) { if (e.key === "Enter") { e.preventDefault(); lPF.focus(); } }); }
        if (lPF) { lPF.addEventListener("keypress", function(e) { if (e.key === "Enter") { e.preventDefault(); _hL(); } }); }
        document.getElementById("searchUser").addEventListener("keypress", function(e) { if (e.key === "Enter") { _sU(); } });
    });

    function _uSAT() {
        if (sessionStorage.getItem("isLoggedIn") === "true") {
            sessionStorage.setItem("lastActivityTime", new Date().toISOString());
        }
    }

    function _l() {
        if (confirm("Anda yakin ingin keluar?")) {
            sessionStorage.removeItem("isLoggedIn");
            location.reload();
        }
    }

    function _gALC(l=16) {
        const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let r = '';
        for (let i = 0; i < l; i++) { r += c.charAt(Math.floor(Math.random() * c.length)); }
        return r;
    }

    function _tU() {
        const uN = document.getElementById("usernameInput").value.trim();
        const eD = document.getElementById("expire").value;
        if (!uN || !eD) { console.log("Nama Pengguna dan Tanggal Expired wajib diisi."); return; }
        if (_a.some(([n, i]) => n === uN)) {
            document.getElementById("generatedLicenseCode").textContent = `❌ Nama Pengguna '${uN}' sudah ada.`; return;
        }
        const lC = _gALC();
        const uD = {}; uD[uN] = { license_code: lC, active: true, expire: eD };
        fetch(_u_db, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(uD) })
        .then(r => {
            if (!r.ok) { throw new Error('Gagal menambahkan pengguna ke Firebase.'); }
            document.getElementById("generatedLicenseCode").textContent = `Kode Lisensi untuk '${uN}' adalah: ${lC}`;
            document.getElementById("usernameInput").value = ''; document.getElementById("expire").value = '';
            const lD = { active: true, expire: eD, device_id: null };
            return fetch(`${_l_db}/${lC}.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv`, {
                method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(lD)
            });
        }).then(r => {
            if (!r.ok) { throw new Error('Gagal menambahkan/memperbarui lisensi di node /licenses.'); }
            _lU();
        }).catch(e => { console.error("Error adding user or license:", e); console.log("❌ Gagal menambahkan pengguna atau lisensi: " + e.message); });
    }

    function _lU() {
        fetch(_u_db).then(r => r.json()).then(d => { _a = Object.entries(d || {}); _sU(); }).catch(e => { console.error("Error loading users:", e); console.log("❌ Gagal memuat daftar pengguna."); });
    }

    function _sU() {
        const sT = document.getElementById("searchUser").value.toLowerCase();
        _d = _a.filter(([uN, i]) => uN.toLowerCase().includes(sT) || (i.license_code || "").toLowerCase().includes(sT));
        _c = 1; _rU();
    }

    function _rU() {
        const tB = document.getElementById("userBody"); const cB = document.getElementById("cardBody");
        tB.innerHTML = ""; cB.innerHTML = "";
        const s = (_c - 1) * _pp; const pU = _d.slice(s, s + _pp);
        pU.forEach(([uN, i]) => {
            const tR = document.createElement("tr");
            // FIX: Menggunakan nama fungsi yang diekspos secara global untuk onclick
            tR.innerHTML = `<td>${uN}</td><td>${i.license_code || "-"}</td><td>${i.active ? "✅ Aktif" : "⛔ Nonaktif"}</td><td><input type="text" class="flatpickr-input" value="${i.expire}" data-user="${uN}" readonly="readonly" /></td><td><button onclick="toggleStatus('${uN}', ${i.active})" style="background-color: ${i.active ? 'var(--primary-color)' : 'var(--accent-color)'};">${i.active ? "Nonaktifkan" : "Aktifkan"}</button><button onclick="hapusUser('${uN}', '${i.license_code || ''}')">🗑️</button><button onclick="resetDevice('${uN}', '${i.license_code || ''}')">🔁</button></td>`;
            tB.appendChild(tR);
            const c = document.createElement("div"); c.className = "user-card";
            // FIX: Menggunakan nama fungsi yang diekspos secara global untuk onclick
            c.innerHTML = `<div><strong>Nama Pengguna:</strong> <span>${uN}</span></div><div><strong>Kode Lisensi:</strong> <span>${i.license_code || "-"}</span></div><div><strong>Status:</strong> <span>${i.active ? "✅ Aktif" : "⛔ Nonaktif"}</span></div><div><strong>Expired:</strong> <input type="text" class="flatpickr-input" value="${i.expire}" data-user="${uN}" readonly="readonly" /></div><button onclick="toggleStatus('${uN}', ${i.active})" style="background-color: ${i.active ? 'var(--primary-color)' : 'var(--accent-color)'};">${i.active ? "Nonaktifkan" : "Aktifkan"}</button><button onclick="resetDevice('${uN}', '${i.license_code || ''}')">🔁 Reset Device</button><button onclick="hapusUser('${uN}', '${i.license_code || ''}')">🗑️ Hapus</button>`;
            cB.appendChild(c);
        });
        document.getElementById("pageInfo").textContent = `Halaman ${_c} dari ${Math.ceil(_d.length / _pp)}`;
        document.querySelector('.pagination button:first-child').disabled = _c === 1;
        document.querySelector('.pagination button:last-child').disabled = _c === Math.ceil(_d.length / _pp);
        _iFI();
    }

    function _pP() { if (_c > 1) { _c--; _rU(); } }
    function _nP() { if (_c < Math.ceil(_d.length / _pp)) { _c++; _rU(); } }

    function _uUD(uN, f, v) {
        fetch(`${_u_db.replace('.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv', '')}/${uN}.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv`, {
            method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ [f]: v })
        }).then(r => { if (!r.ok) { throw new Error('Gagal memperbarui data pengguna.'); } _lU(); }).catch(e => { console.error(`Error updating field ${f} for user ${uN}:`, e); console.log(`❌ Gagal memperbarui ${f} untuk pengguna ${uN}: ` + e.message); });
    }

    function _uLD(lC, f, v) {
        if (!lC) { console.warn("Kode lisensi tidak valid untuk pembaruan data lisensi."); return; }
        fetch(`${_l_db}/${lC}.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv`, {
            method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ [f]: v })
        }).then(r => { if (!r.ok) { throw new Error('Gagal memperbarui data lisensi di node /licenses.'); } }).catch(e => { console.error(`Error updating field ${f} for license ${lC} in /licenses node:`, e); console.log(`❌ Gagal memperbarui ${f} untuk lisensi ${lC} di node /licenses: ` + e.message); });
    }

    function _tS(uN, cS) {
        if (!confirm(`Anda yakin ingin ${cS ? 'menonaktifkan' : 'mengaktifkan'} pengguna '${uN}'?`)) { return; }
        const u = _a.find(([n, _]) => n === uN); if (!u) { console.error(`Pengguna '${uN}' tidak ditemukan.`); return; }
        const lC = u[1].license_code;
        _uUD(uN, 'active', !cS);
        if (lC) { _uLD(lC, 'active', !cS); }
    }

    function _hU(uN, lC) {
        if (!confirm(`Yakin ingin menghapus pengguna '${uN}' dan lisensi terkait '${lC}'?`)) return;
        fetch(`${_u_db.replace('.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv', '')}/${uN}.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv`, { method: "DELETE" })
        .then(r => {
            if (!r.ok) { throw new Error('Gagal menghapus pengguna dari Firebase.'); }
            if (lC) {
                return fetch(`${_l_db}/${lC}.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv`, { method: "DELETE" });
            } return Promise.resolve();
        }).then(r => {
            if (r && !r.ok) { throw new Error('Gagal menghapus lisensi terkait dari node /licenses.'); }
            _lU();
        }).catch(e => { console.error("Error deleting user or license:", e); console.log("❌ Gagal menghapus pengguna atau lisensi: " + e.message); });
    }

    async function _rD(uN, oLC) {
        if (!confirm(`Yakin ingin me-reset Device ID dan mengganti Kode Lisensi untuk pengguna '${uN}'? Ini akan memutuskan tautan lisensi dari perangkat saat ini dan menghasilkan kode baru.`)) return;
        if (!oLC) { console.log(`Tidak ada kode lisensi yang terhubung dengan pengguna '${uN}'. Tidak ada Device ID yang bisa direset atau kode yang diganti.`); return; }
        try {
            let oLI = await fetch(`${_l_db}/${oLC}.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv`).then(r => { if (!r.ok) throw new Error('Gagal mengambil data lisensi lama.'); return r.json(); });
            if (!oLI) { oLI = { active: true, expire: new Date().toISOString().split('T')[0] }; }
            const nLC = _gALC();
            await _uUD(uN, 'license_code', nLC);
            const nLD = { active: oLI.active || true, expire: oLI.expire || new Date().toISOString().split('T')[0], device_id: null };
            const nLF = await fetch(`${_l_db}/${nLC}.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv`, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify(nLD) });
            if (!nLF.ok) { throw new Error('Gagal membuat entri lisensi baru di node /licenses.'); }
            const dOLF = await fetch(`${_l_db}/${oLC}.json?auth=FAyQlzg5X01TscSU66SJ2VaSbB8i96eVK8qtOEWv`, { method: "DELETE" });
            if (!dOLF.ok) { console.warn(`Gagal menghapus lisensi lama '${oLC}' dari node /licenses. Mungkin sudah dihapus atau tidak ada.`); }
            _lU();
        } catch (e) { console.error("Error saat mereset device dan mengganti kode lisensi:", e); console.log("❌ Gagal mereset device dan mengganti kode lisensi: " + e.message); }
    }

    function _iFI() {
        flatpickr("#expire", { locale: "id", dateFormat: "Y-m-d", minDate: "today", enableTime: false, onChange: function(sD, dS, i) { if (i.element.id === "expire") { } } });
        document.querySelectorAll('input.flatpickr-input[data-user]').forEach(i => {
            flatpickr(i, { locale: "id", dateFormat: "Y-m-d", minDate: "today", enableTime: false, onChange: function(sD, dS, inst) {
                const u = inst.element.dataset.user; if (u) { _uUD(u, 'expire', dS); }
            } });
        });
    }

    // Expose functions to global scope (window) for HTML onclick attributes
    window.handleLogin = _hL;
    window.logout = _l;
    window.tambahUser = _tU;
    window.searchUsers = _sU;
    window.prevPage = _pP;
    window.nextPage = _nP;
    window.toggleStatus = _tS; // Exposed _tS as toggleStatus
    window.hapusUser = _hU;     // Exposed _hU as hapusUser
    window.resetDevice = _rD;   // Exposed _rD as resetDevice
    // window.updateSessionActivityTime = _uSAT; // This function is called internally, no need to expose.

})();
    </script>
</body>
</html>
